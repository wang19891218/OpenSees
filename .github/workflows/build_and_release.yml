name: Make Build

env:
  # CMAKE_VERSION: 3.20.1 
  # BUILD_TYPE: Debug
  USERNAME: wang19891218
  OPENSEESVERSOIN: v3.2.0

on:
  workflow_dispatch
  # [ push ]
    # branches: [cmake-build]

jobs:
  build-ubuntu:
    name: ubuntu_build
    runs-on: ubuntu-20.04
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
      #     - uses: claudioperez/OpenSees@cmake-build
      # with: {ref: cmake-build}
      # - uses: lhotari/action-upterm@v1

    - name: Install Tcl
      run: |
        sudo apt-get update
        sudo apt-get install tcl-dev libmysqlclient-dev \
          make tcl8.6 tcl8.6-dev gcc g++ gfortran python3-dev libatlas-base-dev 

    - name: Build
      run: |
        # git pull
        git checkout tags/$OPENSEESVERSOIN
        mkdir $HOME/bin
        mkdir $HOME/lib
        cp -r ../OpenSees $HOME/
        
        cp $HOME/OpenSees/MAKES/Makefile.def.EC2-UBUNTU $HOME/OpenSees/Makefile.def
        cd $HOME/OpenSees
        
        # ls -lah
        # cat Makefile.def
        sed -i 's/\.\/usr\/local/\/usr\/local/g' ./Makefile.def
        sed -i 's/\.\/home/\/home\/runner/g' ./Makefile.def
        
        make
        
        mkdir $HOME/OpenSees_$OPENSEESVERSOIN
        mv $HOME/bin $HOME/OpenSees_$OPENSEESVERSOIN/
        mv $HOME/lib $HOME/OpenSees_$OPENSEESVERSOIN/
        # tar czvf $HOME/OpenSees_$OPENSEESVERSOIN.tar.gz OpenSees_$OPENSEESVERSOIN
        zip -r --compression-method store  $HOME/OpenSees_$OPENSEESVERSOIN.zip $HOME/OpenSees_$OPENSEESVERSOIN
       
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        draft: false
        prerelease: false

    - name: Upload Release Asset
      id: upload-release-asset 
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }} # This pulls from the CREATE RELEASE step above, referencing it's ID to get its outputs object, which include a `upload_url`. See this blog post for more info: https://jasonet.co/posts/new-features-of-github-actions/#passing-data-to-future-steps 
        asset_path: ./$HOME/OpenSees_$OPENSEESVERSOIN.zip
        asset_name: OpenSees_$OPENSEESVERSOIN.zip
        asset_content_type: application/zip
       
